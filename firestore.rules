rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function: Kullanıcı authenticated mı?
    function isAuthenticated() {
      return request.auth != null;
    }

    // Ortak validasyon helper'ları
    function isNonEmptyString(value, maxLen) {
      return value is string && value.size() > 0 && value.size() <= maxLen;
    }

    function isOptionalString(value, maxLen) {
      return value == null || (value is string && value.size() <= maxLen);
    }

    function isOptionalTimestamp(value) {
      return value == null || value is timestamp;
    }

    function isOptionalBoolean(value) {
      return value == null || value is bool;
    }

    function isOptionalNumber(value, min, max) {
      return value == null || ((value is int || value is float) && value >= min && value <= max);
    }

    // Goal dokümanı için alan validasyonu
    function isValidGoal(data) {
      return
        isNonEmptyString(data.userId, 128) &&
        isNonEmptyString(data.title, 200) &&
        isNonEmptyString(data.category, 50) &&
        isOptionalString(data.description, 2000) &&
        isOptionalString(data.motivation, 2000) &&
        data.createdAt is timestamp &&
        isOptionalTimestamp(data.targetDate) &&
        isOptionalTimestamp(data.completedAt) &&
        isOptionalBoolean(data.isArchived) &&
        isOptionalBoolean(data.isCompleted) &&
        (data.progress is int && data.progress >= 0 && data.progress <= 100) &&
        // subGoals dizisi olmalı ve boyutu sınırlı olmalı
        (!('subGoals' in data) || (data.subGoals is list && data.subGoals.size() <= 50));
    }

    // Check-in dokümanı için alan validasyonu
    function isValidCheckIn(data) {
      return
        isNonEmptyString(data.goalId, 128) &&
        isNonEmptyString(data.userId, 128) &&
        data.createdAt is timestamp &&
        (data.score is int && data.score >= 1 && data.score <= 10) &&
        (data.progressDelta is int && data.progressDelta >= -100 && data.progressDelta <= 100) &&
        isOptionalString(data.note, 2000);
    }

    // Note dokümanı için alan validasyonu
    function isValidNote(data) {
      return
        isNonEmptyString(data.goalId, 128) &&
        isNonEmptyString(data.userId, 128) &&
        data.createdAt is timestamp &&
        isNonEmptyString(data.content, 4000);
    }

    // Report dokümanı için alan validasyonu
    function isValidReport(data) {
      return
        isNonEmptyString(data.userId, 128) &&
        isNonEmptyString(data.reportType, 50) &&
        data.periodStart is timestamp &&
        data.periodEnd is timestamp &&
        data.generatedAt is timestamp &&
        isNonEmptyString(data.content, 20000);
    }

    // Users collection - kullanıcılar kendi bilgilerini okuyabilir ve yazabilir
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Sadece kendi user dokümanını yazabilir
      allow write: if isAuthenticated() && request.auth.uid == userId;
      
      // Goals subcollection - kullanıcıya özel hedefler
      match /goals/{goalId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;

        // Validasyon ile güvenli yazma
        allow create, update: if isAuthenticated() &&
          request.auth.uid == userId &&
          request.resource.data.userId == userId &&
          isValidGoal(request.resource.data);

        // Silme sadece sahibi tarafından
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Check-ins subcollection - kullanıcıya özel check-in'ler
      match /checkIns/{checkInId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;

        allow create, update: if isAuthenticated() &&
          request.auth.uid == userId &&
          isValidCheckIn(request.resource.data);

        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Yearly reports subcollection - kullanıcıya özel raporlar (legacy)
      match /yearlyReports/{reportId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;

        allow create, update: if isAuthenticated() &&
          request.auth.uid == userId &&
          isValidReport(request.resource.data);

        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Reports subcollection - kullanıcıya özel raporlar (tüm türler: haftalık, aylık, yıllık)
      match /reports/{reportId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;

        allow create, update: if isAuthenticated() &&
          request.auth.uid == userId &&
          isValidReport(request.resource.data);

        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // Notes subcollection - kullanıcıya özel notlar
      match /notes/{noteId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;

        allow create, update: if isAuthenticated() &&
          request.auth.uid == userId &&
          isValidNote(request.resource.data);

        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }
  }
}
